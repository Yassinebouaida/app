# Khabeer Al-Hay - Makefile
# Ù…Ù„Ù Makefile Ù„ØªØ·Ø¨ÙŠÙ‚ Ø®Ø¨ÙŠØ± Ø§Ù„Ø­ÙŠ

.PHONY: help start stop restart status logs setup-db clean build test deploy

# Default target
help: ## Show this help message
	@echo "ğŸ  Ø®Ø¨ÙŠØ± Ø§Ù„Ø­ÙŠ - Khabeer Al-Hay"
	@echo "================================"
	@echo ""
	@echo "Available commands:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}'
	@echo ""

# Docker commands
start: ## Start all services
	@echo "ğŸš€ Starting Khabeer Al-Hay services..."
	docker-compose up -d
	@echo "âœ… Services started. Use 'make status' to check status."

stop: ## Stop all services
	@echo "ğŸ›‘ Stopping Khabeer Al-Hay services..."
	docker-compose down
	@echo "âœ… Services stopped."

restart: ## Restart all services
	@echo "ğŸ”„ Restarting Khabeer Al-Hay services..."
	docker-compose restart
	@echo "âœ… Services restarted."

status: ## Show current status of all services
	@echo "ğŸ“Š Current Status:"
	@echo "=================="
	docker-compose ps

logs: ## Show logs for all services
	@echo "ğŸ“‹ Showing logs for all services..."
	docker-compose logs -f

# Database commands
setup-db: ## Setup database (migrations, seed data)
	@echo "ğŸ—„ï¸ Setting up database..."
	@echo "â³ Waiting for PostgreSQL to be ready..."
	@until docker exec khabeer_postgres pg_isready -U khabeer_user -d khabeer_al_hay > /dev/null 2>&1; do \
		sleep 2; \
	done
	@echo "âœ… PostgreSQL is ready"
	@echo "ğŸ”„ Running database migrations..."
	docker exec khabeer_backend npm run prisma:migrate
	@echo "ğŸ”§ Generating Prisma client..."
	docker exec khabeer_backend npm run prisma:generate
	@echo "âœ… Database setup completed"

reset-db: ## Reset database (drop and recreate)
	@echo "ğŸ—‘ï¸ Resetting database..."
	docker-compose down -v
	docker-compose up -d postgres
	@echo "â³ Waiting for PostgreSQL to be ready..."
	@until docker exec khabeer_postgres pg_isready -U khabeer_user -d khabeer_al_hay > /dev/null 2>&1; do \
		sleep 2; \
	done
	@echo "âœ… PostgreSQL is ready"
	@echo "ğŸ”„ Running database migrations..."
	docker exec khabeer_backend npm run prisma:migrate
	@echo "ğŸ”§ Generating Prisma client..."
	docker exec khabeer_backend npm run prisma:generate
	@echo "âœ… Database reset completed"

# Development commands
install: ## Install dependencies for all services
	@echo "ğŸ“¦ Installing backend dependencies..."
	cd backend-api && npm install
	@echo "ğŸ“¦ Installing mobile app dependencies..."
	cd mobile-app && flutter pub get
	@echo "âœ… Dependencies installed"

build: ## Build all services
	@echo "ğŸ”¨ Building backend..."
	cd backend-api && npm run build
	@echo "ğŸ”¨ Building mobile app..."
	cd mobile-app && flutter build web
	@echo "âœ… Build completed"

test: ## Run tests for all services
	@echo "ğŸ§ª Running backend tests..."
	cd backend-api && npm run test
	@echo "ğŸ§ª Running mobile app tests..."
	cd mobile-app && flutter test
	@echo "âœ… Tests completed"

# Backend specific commands
backend-install: ## Install backend dependencies
	@echo "ğŸ“¦ Installing backend dependencies..."
	cd backend-api && npm install

backend-dev: ## Start backend in development mode
	@echo "ğŸš€ Starting backend in development mode..."
	cd backend-api && npm run start:dev

backend-build: ## Build backend
	@echo "ğŸ”¨ Building backend..."
	cd backend-api && npm run build

backend-test: ## Run backend tests
	@echo "ğŸ§ª Running backend tests..."
	cd backend-api && npm run test

# Mobile app specific commands
mobile-install: ## Install mobile app dependencies
	@echo "ğŸ“¦ Installing mobile app dependencies..."
	cd mobile-app && flutter pub get

mobile-dev: ## Start mobile app in development mode
	@echo "ğŸš€ Starting mobile app in development mode..."
	cd mobile-app && flutter run -d chrome

mobile-build: ## Build mobile app
	@echo "ğŸ”¨ Building mobile app..."
	cd mobile-app && flutter build web

mobile-test: ## Run mobile app tests
	@echo "ğŸ§ª Running mobile app tests..."
	cd mobile-app && flutter test

# Utility commands
clean: ## Clean up Docker containers and volumes
	@echo "ğŸ§¹ Cleaning up Docker containers and volumes..."
	docker-compose down -v --remove-orphans
	docker system prune -f
	@echo "âœ… Cleanup completed"

logs-backend: ## Show backend logs
	@echo "ğŸ“‹ Showing backend logs..."
	docker-compose logs -f backend

logs-mobile: ## Show mobile app logs
	@echo "ğŸ“‹ Showing mobile app logs..."
	docker-compose logs -f mobile-web

logs-db: ## Show database logs
	@echo "ğŸ“‹ Showing database logs..."
	docker-compose logs -f postgres

# Production commands
deploy: ## Deploy to production
	@echo "ğŸš€ Deploying to production..."
	@echo "âš ï¸  This is a placeholder for production deployment"
	@echo "ğŸ“ Please implement your production deployment strategy"

# Monitoring commands
monitor: ## Open monitoring dashboards
	@echo "ğŸ“Š Opening monitoring dashboards..."
	@echo "ğŸŒ Grafana: http://localhost:3002 (admin/admin123)"
	@echo "ğŸŒ Prometheus: http://localhost:9090"
	@echo "ğŸŒ Backend Health: http://localhost:3000/health"

# Quick start for development
dev: start setup-db ## Quick start for development (start services + setup DB)
	@echo "ğŸ‰ Development environment ready!"
	@echo "ğŸŒ Access URLs:"
	@echo "   Backend API: http://localhost:3000"
	@echo "   GraphQL Playground: http://localhost:3000/graphql"
	@echo "   Mobile Web App: http://localhost:8080"
	@echo "   Admin Dashboard: http://localhost:3001"
	@echo "   Grafana: http://localhost:3002 (admin/admin123)"